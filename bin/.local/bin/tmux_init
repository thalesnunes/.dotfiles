#!/usr/bin/env bash

CMD=""
TOCD=$HOME

CLI_SESS=0
while tmux has-session -t="cli-$CLI_SESS" 2> /dev/null; do
    ((CLI_SESS++))
done
SESS="cli-$CLI_SESS"

while getopts d:s:w: flag; do
    case "$flag" in
        d) TOCD=$OPTARG;;
        s) SESS=$(echo $OPTARG | tr . _);;
        w) WINDOW="-n$(echo $OPTARG | tr . _)";;
    esac
done
CMD=${@:$OPTIND:1}

if tmux has-session -t=$SESS 2> /dev/null; then
     [[ -n $WINDOW ]] && tmux new-window -t $SESS $WINDOW -c $TOCD $CMD
else
    cd "$TOCD"
    tmux new-session -ds $SESS $WINDOW -c $TOCD $CMD
fi

[[ "$SESS" == "cli-"* ]] && tmux set-option -t $SESS detach-on-destroy on

if [[ -z $TMUX ]]; then
    tmux attach-session -t $SESS
else
    tmux switch-client -t $SESS
fi
